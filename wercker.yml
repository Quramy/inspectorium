box: node:8-alpine

build:
  steps:
    - script:
      name: set yarn cache
      code: |
        export YARN_CACHE=$WERCKER_CACHE_DIR/yarn
    - script:
      name: install dependencies
      code: |
        HOME=$YARN_CACHE yarn --pure-lockfile
    - script:
      name: build
      code: |
        yarn bootstrap
        yarn run tsc -p packages/server

push_image:
  steps:
    # - script:
    #   name: remove unused files
    #   code: |
    #     rm -rf .git
    # - internal/docker-push:
    #   working-dir: $WERCKER_SOURCE_DIR
    #   cmd: yarn start
    #   username: _json_key
    #   password: $GCR_JSON_KEY_FILE
    #   tag: latest, $WERCKER_GIT_COMMIT
    #   repository: asia.gcr.io/inspectorium-dev/inspectorium
    #   registry: https://asia.gcr.io/v2
    - script:
      name: prepare kubectl
      code: |
        mkdir -p ${HOME}/.kube
        echo ${KUBE_CONFIG} | base64 --decode > ${HOME}/.kube/config
    - kubectl:
      command: config use-context ${KUBE_CONTEXT_NAME}
    - kubectl:
      command: get deployments
